version: '3'

vars:
  BASE_URL: https://geodpags.skogsstyrelsen.se/arcgis/rest/services
  BASE_DIR: cypress/fixtures
  CATALOG_FILE: '{{.BASE_DIR}}/Geodataportal/services.json'

tasks:
  default:
    cmds:
      - task: fetch-catalog
      - task: process-services

  fetch-catalog:
    cmds:
      - mkdir -p {{.BASE_DIR}}/Geodataportal
      - curl -sS -o {{.CATALOG_FILE}} "{{.BASE_URL}}/Geodataportal?f=pjson"
    status:
      - test -f {{.CATALOG_FILE}}

  process-services:
    deps: [fetch-catalog]
    cmds:
      - |
        jq -r '.services[] | "\(.name)|\(.type)"' {{.CATALOG_FILE}} | while IFS='|' read -r SERVICE_NAME SERVICE_TYPE; do
            SERVICE_DIR="{{.BASE_DIR}}/${SERVICE_NAME}"
            mkdir -p "${SERVICE_DIR}"
            echo "Fetching ${SERVICE_NAME}..."
            echo "writing to: ${SERVICE_DIR}/${SERVICE_NAME}/${SERVICE_TYPE}"
            curl -sS -o "${SERVICE_DIR}/${SERVICE_TYPE}.json" "{{.BASE_URL}}/${SERVICE_NAME}/${SERVICE_TYPE}?f=pjson"
        done

    silent: true

  clean:
    cmds:
      - rm -rf {{.BASE_DIR}}

